# Pipeline CI/CD para Azure Web App for Containers
# Requisito 7: Pipelines CI/CD

trigger:
  branches:
    include:
      - master        # Se sua branch principal for "main", troque aqui para "main"

variables:
  # Variáveis de ambiente para o build / deploy
  - name: azureServiceConnection
    value: 'sc-azure-sprint4'              # Service Connection ARM (Resource Group rg-sprint4-devops)
  - name: acrName
    value: 'acrdevops554681.azurecr.io'    # Login server do seu ACR
  - name: webAppName
    value: 'sprint4-api-rm554681'          # Nome do seu Web App
  - name: dockerRegistryServiceConnection
    value: 'sc-acr-sprint4'                # Service Connection do Azure Container Registry
  - name: imageRepository
    value: 'sprintdevops3-app'             # Nome do repositório de imagem dentro do ACR
  - name: dockerfilePath
    value: '$(Build.SourcesDirectory)/Dockerfile'
  - name: tag
    value: '$(Build.BuildId)'              # Tag da imagem = ID do build
  - group: db-credentials                  # Variable Group com as credenciais do PostgreSQL

stages:
# ============================
# STAGE 1 - CI (Build + Docker)
# ============================
- stage: Build
  displayName: Build e Push da Imagem Docker (CI)
  jobs:
  - job: Build
    displayName: Build da Aplicação e Imagem
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Maven@4
      displayName: 'Maven Package'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean package'             # Build + testes automáticos (Requisito 7a)
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.17'
        mavenVersionOption: 'Default'
        mavenAuthenticateFeed: false
        effectivePomSkip: false
        sonarQubeRunAnalysis: false

    - task: Docker@2
      displayName: 'Build e Push da Imagem para ACR'
      inputs:
        command: 'buildAndPush'
        repository: '$(imageRepository)'    # sprintdevops3-app
        dockerfile: '$(dockerfilePath)'     # Dockerfile na raiz do repo
        containerRegistry: '$(dockerRegistryServiceConnection)'  # sc-acr-sprint4
        tags: |
          $(tag)
          latest
        # Aqui o pipeline gera a imagem e publica no ACR (Requisito 7 - Regra V)

# ============================
# STAGE 2 - CD (Deploy)
# ============================
- stage: Deploy
  displayName: Deploy para Azure Web App (CD)
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: Deploy para Web App
    environment: 'Azure Web App'
    pool:
      vmImage: 'ubuntu-latest'
    variables:
      # Variáveis vindas do Variable Group db-credentials (Regra IV)
      SPRING_DATASOURCE_URL: $(SPRING_DATASOURCE_URL)
      SPRING_DATASOURCE_USERNAME: $(SPRING_DATASOURCE_USERNAME)
      SPRING_DATASOURCE_PASSWORD: $(SPRING_DATASOURCE_PASSWORD)
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebAppContainer@1
            displayName: 'Azure Web App Deploy'
            inputs:
              azureSubscription: '$(azureServiceConnection)'     # sc-azure-sprint4
              appName: '$(webAppName)'                          # sprint4-api-rm554681
              containers: '$(acrName)/$(imageRepository):$(tag)' # acrdevops554681.azurecr.io/sprintdevops3-app:<buildId>
              appSettings: |                                    # Configurações da aplicação no Web App
                SPRING_PROFILES_ACTIVE prod
                SPRING_DATASOURCE_URL $(SPRING_DATASOURCE_URL)
                SPRING_DATASOURCE_USERNAME $(SPRING_DATASOURCE_USERNAME)
                SPRING_DATASOURCE_PASSWORD $(SPRING_DATASOURCE_PASSWORD)
            # CD: Deploy automático após novo artefato (imagem Docker) - Requisito 7b
